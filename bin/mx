#!/bin/sh

# check if tmux needs to be booted up
tmux list-sessions | cut -d ':' -f 1 | grep '^_shared$' > /dev/null
if [ "$?" -ne 0 ]; then
  tmux new-session -d -s "$SESSION" -n 'WeeChat' weechat

  tmux new-window -n 'media' cmus

  local logpath=/Users/"$USER"/src/"$USER"/knowledge
  tmux new-window -n 'log' -c "$logpath"
  tmux send-keys "$EDITOR" C-m
  tmux split-window -h -c "$logpath"
  tmux resize-pane -R 5

  local confpath=/Users/"$USER"/src/"$USER"/dotfiles
  tmux new-window -n 'conf' -c "$confpath"
  tmux send-keys "$EDITOR" C-m
  tmux split-window -h -c "$confpath"
  tmux resize-pane -R 5
fi

# tmux 1.9a+ doesn't like .'s in session names
SESSION="$(pwd | awk -F"/" '{print $NF}')"

if ! (tmux list-sessions | grep '^[_a-zA-Z].' | grep -q ^"$SESSION"\$); then
  if [ -d "$PROJECTS"/"$SESSION" ]; then cd "$PROJECTS"/"$SESSION"; fi
  tmux new-session -s "$SESSION" -d -n ''
  tmux send-keys "$EDITOR" C-m #':CtrlP' C-m
  tmux split-window -h
  tmux resize-pane -R 5
  tmux select-window -t "$SESSION"
  tmux link-window -s _shared:WeeChat -t 9
  tmux link-window -s _shared:media -t 8
  tmux link-window -s _shared:log -t 7
  tmux link-window -s _shared:conf -t 6
  tmux select-window -t 1
fi

if [ -z "$TMUX" ]; then tmux attach -t "$SESSION";
else tmux switch-client -t "$SESSION"; fi
